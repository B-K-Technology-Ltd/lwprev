
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://developer.lightwarelidar.com/landing-moving-platform/software/">
      
      
        <link rel="prev" href="../hardware/">
      
      
        <link rel="next" href="../conclusion/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.21">
    
    
      
        <title>Software - LightWare Developer Portal</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.66ac8b77.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="deep-orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#configuration" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="LightWare Developer Portal" class="md-header__button md-logo" aria-label="LightWare Developer Portal" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            LightWare Developer Portal
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Software
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="LightWare Developer Portal" class="md-nav__button md-logo" aria-label="LightWare Developer Portal" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    LightWare Developer Portal
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Welcome to LightWare's Developer Portal
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Landing on a Moving Platform
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Landing on a Moving Platform
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Summary
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../plan/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Plan
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../components/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Components
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hardware
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Software
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Software
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#payload-sdk-raspberry-pi" class="md-nav__link">
    <span class="md-ellipsis">
      Payload SDK &amp; Raspberry Pi
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lw20c" class="md-nav__link">
    <span class="md-ellipsis">
      LW20/C
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#project-code" class="md-nav__link">
    <span class="md-ellipsis">
      Project Code
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Project Code">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#connecting-to-the-aircraft" class="md-nav__link">
    <span class="md-ellipsis">
      Connecting to the Aircraft
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connection-to-the-lw20c" class="md-nav__link">
    <span class="md-ellipsis">
      Connection to the LW20/c
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plane-detection-logic" class="md-nav__link">
    <span class="md-ellipsis">
      Plane detection logic
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Plane detection logic">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maintaining-the-application-active-until-triggered-from-the-ground" class="md-nav__link">
    <span class="md-ellipsis">
      Maintaining the application active until triggered from the ground.
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#following-the-landing-target" class="md-nav__link">
    <span class="md-ellipsis">
      Following the landing target.
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#landing-risk-validation" class="md-nav__link">
    <span class="md-ellipsis">
      Landing risk validation.
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#landing-routine" class="md-nav__link">
    <span class="md-ellipsis">
      Landing routine
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../conclusion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Conclusion
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Precision Positioning
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Precision Positioning
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../precision-positioning/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Summary
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../precision-positioning/plan/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Plan
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../precision-positioning/components/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Components
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../precision-positioning/hardware/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hardware
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../precision-positioning/software/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Software
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../precision-positioning/conclusion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Conclusion
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Sensor Point of Interest
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Sensor Point of Interest
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../spoi/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Summary
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../spoi/plan/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Plan
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../spoi/components/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Components
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../spoi/hardware/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hardware
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../spoi/software/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Software
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../spoi/conclusion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Conclusion
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#payload-sdk-raspberry-pi" class="md-nav__link">
    <span class="md-ellipsis">
      Payload SDK &amp; Raspberry Pi
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lw20c" class="md-nav__link">
    <span class="md-ellipsis">
      LW20/C
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#project-code" class="md-nav__link">
    <span class="md-ellipsis">
      Project Code
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Project Code">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#connecting-to-the-aircraft" class="md-nav__link">
    <span class="md-ellipsis">
      Connecting to the Aircraft
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connection-to-the-lw20c" class="md-nav__link">
    <span class="md-ellipsis">
      Connection to the LW20/c
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plane-detection-logic" class="md-nav__link">
    <span class="md-ellipsis">
      Plane detection logic
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Plane detection logic">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maintaining-the-application-active-until-triggered-from-the-ground" class="md-nav__link">
    <span class="md-ellipsis">
      Maintaining the application active until triggered from the ground.
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#following-the-landing-target" class="md-nav__link">
    <span class="md-ellipsis">
      Following the landing target.
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#landing-risk-validation" class="md-nav__link">
    <span class="md-ellipsis">
      Landing risk validation.
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#landing-routine" class="md-nav__link">
    <span class="md-ellipsis">
      Landing routine
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>Software</h1>

<h2 id="configuration">Configuration</h2>
<p>Before we dive into the code for the application, we need to set up all the baseline components</p>
<h3 id="payload-sdk-raspberry-pi">Payload SDK &amp; Raspberry Pi</h3>
<p>DJI covers really well how to get the Raspberry Pi setup, so follow the <a href="https://developer.dji.com/doc/payload-sdk-tutorial/en/quick-start/quick-guide/raspberry-pi.html#software-environment-setup">set up steps here</a></p>
<p>Once you can run the sample code, we can move to the next step.</p>
<p>Make sure to configure the Raspberry Pi to connect to your local wifi if available.</p>
<p>Also, for convenience, make sure you have set up SSH access.</p>
<p>While you are in the <code>Raspberry Pi Configuration</code> screen (from the top left menu), turn on "I2C"</p>
<h3 id="lw20c">LW20/C</h3>
<p>Each LW20/c comes configured with <code>0x66</code> as a I2C address, so we need to assign a new one to each device.</p>
<p>To do so, you can use the <a href="https://lightwarelidar.com/resources-software/">LightWare Studio App</a>. 
Download the app, connect the sensor to a FTDI cable (the same type from the kit) and follow the instructions from the <a href="https://lightwarelidar.com/resources-active-manuals-datasheets/">user manual</a>.</p>
<p>We want to have a dedicated address for each, so let's use <code>0x66</code>, <code>0x67</code>, <code>0x68</code>, <code>0x69</code>.
You'll notice that in LightWare Studio, the value are in decimal. Simply increase by 1.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Mark the address on each sensor as their positioning on the aircaft will matter for future logics.</p>
</div>
<p>Reconnect all the sensors to the pi, and let's confirm that we can see them.</p>
<p>On the pi, if you don't have them (unlikely scenario), install the i2c tooling:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>i2c-tools
</code></pre></div></p>
<p>Then, verify you can see the sensors using:</p>
<div class="highlight"><pre><span></span><code>i2cdetect<span class="w"> </span>-y<span class="w"> </span><span class="m">1</span>
</code></pre></div>
<p>You should see something like this:</p>
<div class="highlight"><pre><span></span><code><span class="w">     </span><span class="m">0</span><span class="w">  </span><span class="m">1</span><span class="w">  </span><span class="m">2</span><span class="w">  </span><span class="m">3</span><span class="w">  </span><span class="m">4</span><span class="w">  </span><span class="m">5</span><span class="w">  </span><span class="m">6</span><span class="w">  </span><span class="m">7</span><span class="w">  </span><span class="m">8</span><span class="w">  </span><span class="m">9</span><span class="w">  </span>a<span class="w">  </span>b<span class="w">  </span>c<span class="w">  </span>d<span class="w">  </span>e<span class="w">  </span>f
<span class="m">00</span>:<span class="w">                         </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>
<span class="m">10</span>:<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>
<span class="m">20</span>:<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>
<span class="m">30</span>:<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>
<span class="m">40</span>:<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>
<span class="m">50</span>:<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>
<span class="m">60</span>:<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span><span class="m">66</span><span class="w"> </span><span class="m">67</span><span class="w"> </span><span class="m">68</span><span class="w"> </span><span class="m">69</span><span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>
<span class="m">70</span>:<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w"> </span>--<span class="w">  </span>
</code></pre></div>
<p>You are now ready to dive into the code.</p>
<h2 id="project-code">Project Code</h2>
<p>First of all, all the code for we are going to go over is available <a href="../code/landing-moving-platform">here</a>.</p>
<p>The code is in itself, functionally simple. We started by writing several classes that will abstract the sensor, the array of them and the vehicle interaction.
For the vehicle and to remain true to the content set by DJI, we used the same <code>Application</code> class from their <a href="https://github.com/dji-sdk/Payload-SDK/blob/master/samples/sample_c%2B%2B/platform/linux/nvidia_jetson/application/application.hpp">sample code</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Remember that this project isn't production ready. If you want to deliver this functionality you'll have to finish parts of the work.</p>
</div>
<h3 id="connecting-to-the-aircraft">Connecting to the Aircraft</h3>
<p>Because the Payload SDK does the work for us, once we are set up with the hardware, the work becomes as simple as this:</p>
<div class="highlight"><pre><span></span><code><span class="n">Application</span><span class="w"> </span><span class="o">*</span><span class="n">vehicle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Create the vehicle instance to connect</span>
<span class="w">    </span><span class="c1">// We are reusing the Application object from DJI&#39;s sample for clarity only.</span>
<span class="w">    </span><span class="n">vehicle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Application</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span>
</code></pre></div>
<p>From this point on, the vehicle object can be used to abstract vehicle functions. </p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The Payload SDK uses functions. These would be accessible in the global space, but structure with objects is a neater way to organize functions.</p>
</div>
<h3 id="connection-to-the-lw20c">Connection to the LW20/c</h3>
<p>Following the logic of abstraction, we are going to create two objects: <code>LW20</code> and <code>SensorArray</code>.</p>
<p><code>LW20</code> is used to abstract a single sensor. This includes all controls and reads.</p>
<p><code>SensorArray</code> is specific to this project and abstracts the four sensors in their physical configuration.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A lot more effort can be put in these abstractions should the need come to expand on the current approach. 
These classes are great places to contain it.</p>
</div>
<p>First, we bring in all the headers needed for future work and then declare the class:</p>
<div class="highlight"><pre><span></span><code><span class="c1">//</span>
<span class="c1">// Created by LightWare.</span>
<span class="c1">// LW20/c Interface</span>
<span class="c1">//</span>

<span class="cp">#pragma once</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;atomic&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;thread&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/ioctl.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;asm/ioctl.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;fcntl.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">LW20</span><span class="w"> </span><span class="p">{</span>
</code></pre></div>
<p>Then we define a <code>ioctl</code> configuration macro. This is necessary because we work on a Raspberry Pi 5 and the wiringPi which handles these variations isn't available.</p>
<div class="highlight"><pre><span></span><code><span class="cp">#define I2C_SLAVE   0x0703</span>
</code></pre></div>
<p>Next, we can implement the public interface which manages the life cycle of the abstraction and protected access to private information:</p>
<div class="highlight"><pre><span></span><code><span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">LW20</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="o">~</span><span class="n">LW20</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">connect</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i2cAddress</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">_deviceAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2cAddress</span><span class="p">;</span>

<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">device</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/dev/i2c-1&quot;</span><span class="p">;</span><span class="w"> </span><span class="c1">// This may change, wiringPi has a good discovery for this, but it&#39;s not available yet on pi5.</span>
<span class="w">        </span><span class="n">_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="w"> </span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDWR</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_fd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;I2C Bus file could not be opened&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;I2C Bus opened on FD: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">_fd</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ioctl</span><span class="w"> </span><span class="p">(</span><span class="n">_fd</span><span class="p">,</span><span class="w"> </span><span class="n">I2C_SLAVE</span><span class="p">,</span><span class="w"> </span><span class="n">i2cAddress</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Unable to select I2C device: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">_threadRunning</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">);</span>
<span class="w">                </span><span class="n">_runningThread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LW20</span><span class="o">::</span><span class="n">loop</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">disconnect</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">_threadRunning</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">);</span>
<span class="w">        </span><span class="n">close</span><span class="p">(</span><span class="n">_fd</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">latestDistance</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">_latestDistance</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p>Last, we do the private implementation which covers the internal loop running in a background thread to read the data from the sensor and the protected variables.</p>
<div class="highlight"><pre><span></span><code><span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">_threadRunning</span><span class="p">{</span><span class="nb">false</span><span class="p">};</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="w"> </span><span class="n">_runningThread</span><span class="p">;</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">_deviceAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x66</span><span class="p">;</span><span class="w"> </span><span class="c1">// default factory value</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">_fd</span><span class="p">;</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">_latestDistance</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"> </span><span class="c1">// in cm</span>

<span class="w">    </span><span class="c1">// Loop running in background thread.</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">_threadRunning</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">))</span><span class="w">  </span><span class="p">{</span>
<span class="w">            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">byte</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read</span><span class="p">(</span><span class="n">_fd</span><span class="p">,</span><span class="w"> </span><span class="n">byte</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;I2C Device with address &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">_deviceAddress</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; was not available&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">distanceRead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">byte</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">byte</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;[&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">_deviceAddress</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;] Distance: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">distanceRead</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;cm&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

<span class="w">                </span><span class="n">_latestDistance</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="n">distanceRead</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="n">usleep</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The way this class is set, the address is defined during the connect function. 
You could just as easily set it at allocation and have a parameter-less connect function.
This is just a matter of preference.</p>
</div>
<p>Now that we have a single sensor imlementation sorted, we need to move onto the <code>SensorArray</code></p>
<p>Again, this object is a convenience luxury which makes the main business logic really light and abstracted behind trusted classes.</p>
<p>As before, we start with the header call we will need and class declaration.</p>
<div class="highlight"><pre><span></span><code><span class="c1">//</span>
<span class="c1">// Created by LightWare.</span>
<span class="c1">// Software representation of the LW20/c quad sensor array for platform detection</span>
<span class="c1">//</span>

<span class="cp">#pragma once</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;LW20.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;limits&gt;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SensorArray</span><span class="w"> </span><span class="p">{</span>
</code></pre></div>
<p>The public interface handles the life cycle of the sensors:</p>
<div class="highlight"><pre><span></span><code><span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">SensorArray</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">_sensor1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LW20</span><span class="p">();</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">_sensor2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LW20</span><span class="p">();</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">_sensor3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LW20</span><span class="p">();</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">_sensor4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LW20</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="o">~</span><span class="n">SensorArray</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">_sensor1</span><span class="p">;</span>
<span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">_sensor2</span><span class="p">;</span>
<span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">_sensor3</span><span class="p">;</span>
<span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">_sensor4</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Connects the entire array and start receiving distances</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">connect</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">_sensor1</span><span class="o">-&gt;</span><span class="n">connect</span><span class="p">(</span><span class="mh">0x66</span><span class="p">);</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">_sensor2</span><span class="o">-&gt;</span><span class="n">connect</span><span class="p">(</span><span class="mh">0x67</span><span class="p">);</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">_sensor3</span><span class="o">-&gt;</span><span class="n">connect</span><span class="p">(</span><span class="mh">0x68</span><span class="p">);</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">_sensor4</span><span class="o">-&gt;</span><span class="n">connect</span><span class="p">(</span><span class="mh">0x69</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Average distance in cm</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">averageDistance</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">sensor1LastRead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">_sensor1</span><span class="o">-&gt;</span><span class="n">latestDistance</span><span class="p">();</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">sensor2LastRead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">_sensor2</span><span class="o">-&gt;</span><span class="n">latestDistance</span><span class="p">();</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">sensor3LastRead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">_sensor3</span><span class="o">-&gt;</span><span class="n">latestDistance</span><span class="p">();</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">sensor4LastRead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">_sensor4</span><span class="o">-&gt;</span><span class="n">latestDistance</span><span class="p">();</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">sensor1LastRead</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sensor2LastRead</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sensor3LastRead</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sensor4LastRead</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Return the maximum differences between the closest and the furthest away hit</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">maxDelta</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">sensor1LastRead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">_sensor1</span><span class="o">-&gt;</span><span class="n">latestDistance</span><span class="p">();</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">sensor2LastRead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">_sensor2</span><span class="o">-&gt;</span><span class="n">latestDistance</span><span class="p">();</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">sensor3LastRead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">_sensor3</span><span class="o">-&gt;</span><span class="n">latestDistance</span><span class="p">();</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">sensor4LastRead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">_sensor4</span><span class="o">-&gt;</span><span class="n">latestDistance</span><span class="p">();</span>

<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">distances</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">sensor1LastRead</span><span class="p">,</span><span class="w"> </span><span class="n">sensor2LastRead</span><span class="p">,</span><span class="w"> </span><span class="n">sensor3LastRead</span><span class="p">,</span><span class="w"> </span><span class="n">sensor4LastRead</span><span class="p">};</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">lowest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">();</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">highest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;::</span><span class="n">min</span><span class="p">();</span>

<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">lowest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">lowest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">highest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">highest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">highest</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lowest</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p>Private interfaces aren't doing much except holding onto the sensor pointers.</p>
<div class="highlight"><pre><span></span><code><span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">LW20</span><span class="w"> </span><span class="o">*</span><span class="n">_sensor1</span><span class="p">;</span>
<span class="w">    </span><span class="n">LW20</span><span class="w"> </span><span class="o">*</span><span class="n">_sensor2</span><span class="p">;</span>
<span class="w">    </span><span class="n">LW20</span><span class="w"> </span><span class="o">*</span><span class="n">_sensor3</span><span class="p">;</span>
<span class="w">    </span><span class="n">LW20</span><span class="w"> </span><span class="o">*</span><span class="n">_sensor4</span><span class="p">;</span>

<span class="p">};</span>
</code></pre></div>
<p>Now that we have an abstraction for the vehicle and the sensor array, it's time to tie it all up together.</p>
<h3 id="plane-detection-logic">Plane detection logic</h3>
<p>As the purpose of this tutorial is to cover how to leverage the sensors, we are taking the most simplistic approach to solving this problem. 
This means there is obviously a lot of room for improvements towards delivering a resilient and production ready solution.
We will cover a few next steps should you want to take it further after we covered the simple solution we offer.</p>
<p>Back to the <code>main.cpp</code> file in the <code>main</code> function, after we created the abstraction for the vehicle, we create the abstraction for the sensor array and connect it.</p>
<p>After this, we assume we are in checking to land logic. We loop until the condition met is hit, then we exit the loop and trigger the landing:</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Create the vehicle instance to connect</span>
<span class="w">    </span><span class="c1">// We are reusing the Application object from DJI&#39;s sample for clarity only.</span>
<span class="w">    </span><span class="n">vehicle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Application</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span>

<span class="w">    </span><span class="n">sensorArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SensorArray</span><span class="p">();</span>
<span class="w">    </span><span class="n">sensorArray</span><span class="o">-&gt;</span><span class="n">connect</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Check loop</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">checkingToLand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">flatEnough</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="c1">// in cm; 10cm -&gt; ~15° plane</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">checkingToLand</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">maxDelta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sensorArray</span><span class="o">-&gt;</span><span class="n">maxDelta</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Condition to determine a landing opportunity.</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">maxDelta</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">flatEnough</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">maxDelta</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">checkingToLand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p>As you can see this is incredibly simple in this form so here are extra next steps for your consideration:</p>
<h4 id="maintaining-the-application-active-until-triggered-from-the-ground">Maintaining the application active until triggered from the ground.</h4>
<p>This current code will enter in checking to land logic as soon as it's launched. It's not something that's practical in the real world. </p>
<p>What you'd want is for this app to launch with the life cycle of the vehicle and the logic entering once a pilot, operator or logic triggers it.
We can't even cover all the way to handle these three scenarios, but assuming you have a pilot and a ground application, you can leverage <a href="https://developer.dji.com/doc/payload-sdk-api-reference/en/practice/mop-channel.html">MOP</a>.
MOP is a feature of the MobileSDK and PayloadSDK which allows a MobileSDK application to send custom commands to a PayloadSDK application.
MOP has multiple names in the DJI world. It's also refered to SDK Interconnection and <a href="https://developer.dji.com/api-reference-v5/android-api/Components/IPipelineManager/IPipelineManager.html">Pipeline</a>
 on the Android MSDK.</p>
<p>Regardless, they will allow you to build a button on the UI of a MobileSDK app that can trigger this code to enter 'checking to land' logic.</p>
<h4 id="following-the-landing-target">Following the landing target.</h4>
<p>This is another element we skipped over because there is so many ways to go over it.</p>
<p>You could use a dedicated camera sensor, or the <a href="https://developer.dji.com/doc/payload-sdk-tutorial/en/function-set/advanced-function/camera-video-stream-transmission.html">existing PayloadSDK stream</a>.</p>
<p>Regardless, you'll likely reuse the triggering we covered before to enter 'follow the target' logic which itself could trigger the 'check to land' logic itself.</p>
<h4 id="landing-risk-validation">Landing risk validation.</h4>
<p>The logic we implemented assumes that committing to a landing from <em>any</em> height after reading a plane of about 15° is safe. Big assumption.</p>
<p>In a more practical sense, the plane validation of the ground would depend on the characteristic of your moving platform.</p>
<p>For instance, landing on a ground vehicle on a road is likely to have a much more stable plane (smaller range, slower variation).
On the other hand, landing on a sea ship will dramatically vary with the weather condition, the type of ship and the operation context. 
If you land on an inspection boat after an off-shore wind turbine, you're likely looking at a fairly stable motion on all aspect than if you're landing on a military ship at sea state 4.</p>
<h3 id="landing-routine">Landing routine</h3>
<p>Finally, now that the logic is ready to commit, landing is a single function call behind an abstraction:</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">checkingToLand</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// We exited the loop flagging we aren&#39;t checking to land, so we are landing.</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Landing...&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

<span class="w">        </span><span class="n">vehicle</span><span class="o">-&gt;</span><span class="n">land</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.expand", "navigation.path"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.a7c05c9e.min.js"></script>
      
    
  </body>
</html>